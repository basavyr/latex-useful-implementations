\documentclass[12pt]{article}

% \graphicspath{Figures/}  % Location of the graphics files (set up for graphics to be in PDF format)
\usepackage{float}
\usepackage{amsmath}
\usepackage{multirow}
\usepackage{xcolor}
\usepackage{lipsum}
\usepackage{siunitx}
\usepackage{physics}
\usepackage{graphicx}
\usepackage{mathrsfs}
\usepackage{verbatim}  % Needed for the "comment" environment to make LaTeX comments

%% ------------------ tikz ---------------------------------------
\usepackage{pgfplots}
\usepackage{tikz}
\usepackage{tikz-layers}
\usetikzlibrary{shapes.geometric, arrows,cd}
\tikzstyle{startstop} = [rectangle, rounded corners, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=white]
\tikzstyle{arrow1}=[ultra thick,->,>=stealth]
\tikzstyle{arrow}=[thick,->,>=stealth]
\tikzset{
  shift left/.style ={commutative diagrams/shift left={#1}},
  shift right/.style={commutative diagrams/shift right={#1}}
}
\pgfplotsset{compat=1.17}

\begin{document}

\newcommand\gauss[2]{1/(#2*sqrt(2*pi))*exp(-((x-#1)^2)/(2*#2^2))} % Gauss function, parameters mu and sigma
\usepgfplotslibrary{fillbetween}
\usetikzlibrary{positioning}
\usetikzlibrary{shapes.multipart}
\usetikzlibrary{arrows,calc,fit}
\usetikzlibrary{matrix,backgrounds,decorations.pathreplacing,positioning}
\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}
\begin{center}
    \begin{figure}
        \centering
        \begin{tikzpicture}[every text node part/.style={align=center}]
            
            % draw a background box for the density overlap and the two gaussian curves
            \node[rectangle, very thick,dashed,draw=black,fill=none] (huge-container-box) [minimum height=5cm,minimum width=12cm,xshift=0.7cm,yshift=-0.3cm] at (2,2.5) {};
            
            \begin{scope}[xshift=1cm]
                % add coupling schematic
                \draw[-latex] [thick, color=black,dashed] (1.5,6) -- (6,6) node [pos=1,above] {$m$-axis};
                \draw[-latex] [thick, color=black,dashed] (1.5,6) -- (1.5,9) node [pos=1,above] {$s$-axis};
                \draw[-latex] [ultra thick, color=black!60!green] (1.5,6) -- (4,6) node [yshift=0.4cm] {$\mathbf{j}_{\mathscr{C}}$};
                \draw[-latex] [ultra thick, color=magenta] (1.5,6) -- (1.5,8) node [xshift=-0.5cm] (my-arrow) {$\mathbf{j}_{\mathcal{Q}_p}$};
                % \draw[-latex] [ultra thick, color=magenta] (1.5,6) -- (1.5,8) node [pos=1,above,xshift=-1cm] (my-arrow) {$\mathbf{j}_{\mathcal{Q}_p}$};
                \node[rectangle, draw=black, fill=none,anchor=south west] at (1.5,6) {};
                \node[rectangle, draw=black, fill=green!10,anchor=south west] at (3.5,7.5) (coupling-box) {$(\mathcal{Q}_p+\mathscr{C})$\\ Coupling};
            \end{scope}
            
            \node[rectangle, draw=black, thick, fill=green!10, inner sep=0.2cm] at (2,-1.8) (first-box) {\textbf{Minimized} short-range interaction \\ \\ $\mathcal{Q}_p+\mathscr{C}$ = \emph{attractive}};
            
            \node[rectangle, draw=black, thick, fill=green!10, inner sep=0.2cm] (second-box) [below=of first-box] {\textbf{Minimal} energy (PES)};
            
            \node[rectangle, draw=black, thick, fill=green!10, inner sep=0.2cm] (third-box) [below=of second-box] {\textbf{Stable triaxial shape} \\ $\downarrow$ \\ \textbf{Wobbling Motion}};

            \node[rectangle, draw=black,xshift=6cm,yshift=2cm,fill=green!10] (maximal-box) {\textbf{Maximal overlap} \\ between \\ {\color{magenta}$\mathcal{D}\left(\mathcal{Q}_p\right)$} and {\color{black!60!green}$\mathcal{D}\left(\mathscr{C}\right)$}};


            % \draw[-latex] [very thick,black] (inside-node.east) -- ($(inside-node.east)+(2.2,0)$) |- node [xshift=-1.9cm,yshift=2.7cm] (maximal-box) {\textbf{Maximal overlap} \\ between \\ {\color{magenta}$\mathcal{D}\left(\mathcal{Q}_p\right)$} and {\color{black!60!green}$\mathcal{D}\left(\mathscr{C}\right)$}} (first-box.east);
            % \draw[-latex] [very thick,black] (first-box) -- node[circle,draw=black,xshift=1cm] {a} (second-box);
            \draw[-latex] [very thick,black] (first-box) -- node[circle,draw=black,xshift=1cm] {$4$} (second-box);
            \draw[-latex] [very thick,black] (second-box) -- node[circle,draw=black,xshift=1cm] {$5$} (third-box);
            % \draw[-latex] [very thick, color=black] (1.5,5.5) -| (maximal-box.east);
            \draw[-latex] [very thick, color=black] (coupling-box.east) -- ($(coupling-box.east)-(-3,0)$) |- node[circle,draw=black,xshift=-0.6cm,yshift=3.3cm] {$2$} (maximal-box.east);

            \begin{axis}[scale=0.6,xshift=-2cm,every axis plot post/.append style={
                mark=none,domain=-2:3,samples=50,smooth}, % All plots: from -2:2, 50 samples, smooth, no marks
                axis x line*=bottom, % no box around the plot, only x and y axis
                axis y line*=left, % the * suppresses the arrow tips
                axis line style={draw=none},
                xtick=\empty, ytick=\empty,
                enlargelimits=false, 
                clip=false, 
                axis on top,
                grid = major,
                legend style={at={(1,1)},anchor=north,legend cell align=left}
                ]
                % extend the axes a bit to the right and top
                
                \addplot [name path=particle-density, color=magenta,very thick] {\gauss{0}{0.5}};
                \addplot [name path=core-density, color=black!60!green,very thick] {\gauss{0.5}{0.65}};
                \legend{$\mathcal{D}\left(\mathcal{Q}_p\right)$,$\mathcal{D}\left(\mathscr{C}\right)$}
                \path[name path=axis] (axis cs:1,0) -- (axis cs:2,0);
                
                % path for fixing boundaries which will be used to fill common region between gaussian curves
                \path[name path=lower,intersection segments={of=particle-density and core-density, sequence={L1 -- R2 -- L3}}];
                
                \node[rectangle, draw=none, thick, fill=none] at (axis cs: 0.8,0.9) (inside-node) {Density distributions for $\mathcal{Q}_p$ and $\mathscr{C}$};
                
                \addplot[color=gray!30] fill between[of= lower and axis];
            \end{axis}

            \begin{scope}[yshift=6cm,xshift=-4cm]
                % draw Fermi orbital for a j-particle
                \node[rectangle, very thick,draw=black,fill=green!10] (jshell-box) [minimum height=3cm,minimum width=2cm] at (2.5,1.5) {};
                \foreach \x [count=\xi] in {0.1,0.2,0.3,0.4,0.5,0.6} { 
                    \draw (2,\xi em) -- (3,\xi em) ;
                }
                \node at (1.8,0.4) {$\mathcal{Q}_p$};
                \node[circle,draw=none,fill=magenta] at (2.5,0.4) {};
                \node[] at (2.5,-0.5) {$j$-shell};
            \end{scope}

            %draw arrow from jshell to coupling box
            \draw[-latex,very thick] (jshell-box.north) -- ($(jshell-box.north)+(0,1cm)$) node[circle,draw=black,yshift=-0.4cm,xshift=7.7cm] {$1$} -| (coupling-box);

            % connect maximal overlap with minimal energy
            \draw[-latex,very thick] (maximal-box.south) |- ($(first-box.east)+(0.2,0)$) |- (first-box.east);
        
        \end{tikzpicture}
        
        \caption{The workflow of a quasi-particle with particle character $\mathcal{Q}_p$ in its coupling with a triaxial rotor $\mathscr{C}$.}
        \label{advanced-quasiparticle-coupling-1}
    \end{figure}
\end{center}

\end{document}
